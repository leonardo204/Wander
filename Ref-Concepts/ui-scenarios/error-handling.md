[← 인덱스](index.md)

---

## 10. 예외 케이스 및 에러 처리

### 10.1 예외 케이스 분류

```mermaid
graph TB
    subgraph "예외 케이스 분류"
        A[예외 케이스]

        A --> B[권한 관련]
        A --> C[데이터 관련]
        A --> D[네트워크 관련]
        A --> E[처리 오류]
        A --> F[사용자 입력 오류]

        B --> B1[사진 권한 거부]
        B --> B2[사진 권한 제한]
        B --> B3[위치 권한 거부]

        C --> C1[GPS 없는 사진]
        C --> C2[시간 정보 없음]
        C --> C3[손상된 메타데이터]
        C --> C4[저장 공간 부족]

        D --> D1[Geocoding 실패]
        D --> D2[AI API 오류]
        D --> D3[공유 실패]

        E --> E1[분석 실패]
        E --> E2[이미지 생성 실패]
        E --> E3[저장 실패]

        F --> F1[잘못된 API Key]
        F --> F2[선택 사진 없음]
        F --> F3[중복 기록]
    end
```

### 10.2 권한 관련 예외 처리

#### 10.2.1 사진 권한 완전 거부

```mermaid
flowchart TD
    A[사진 접근 시도] --> B{권한 상태 확인}

    B -->|denied| C[권한 거부 화면 표시]
    C --> D[설정으로 이동 버튼]
    D --> E{사용자 선택}

    E -->|설정으로 이동| F[iOS 설정 앱 열기]
    F --> G[앱 포커스 복귀 시 권한 재확인]
    G --> H{권한 변경됨?}
    H -->|Yes| I[정상 플로우 계속]
    H -->|No| C

    E -->|취소| J[이전 화면으로]
```

**권한 거부 화면 UI:**
```
┌─────────────────────────────────┐
│                                 │
│                                 │
│         📷 ❌                    │
│                                 │
│   사진 접근 권한이 필요해요      │
│                                 │
│   Wander는 사진의 메타데이터를  │
│   분석하여 여행 기록을          │
│   만들어 드립니다.              │
│                                 │
│   설정에서 사진 접근을          │
│   허용해 주세요.                │
│                                 │
│                                 │
│   [    설정으로 이동    ]       │
│   [       취소        ]        │
│                                 │
└─────────────────────────────────┘
```

#### 10.2.2 사진 권한 제한 (일부만 허용)

```mermaid
flowchart TD
    A[사진 선택 화면 진입] --> B{권한 상태 확인}

    B -->|limited| C[제한 모드 배너 표시]
    C --> D[허용된 사진만 표시]

    D --> E{사용자 액션}
    E -->|더 많은 사진 추가 버튼| F[PHPickerViewController 표시]
    F --> G[추가 사진 선택]
    G --> H[선택 사진 목록에 추가]
    H --> D

    E -->|전체 접근 허용| I[설정으로 이동 안내]
```

**제한 모드 배너:**
```
┌─────────────────────────────────┐
│ ⚠️ 일부 사진만 접근 가능합니다   │
│ [더 많은 사진 추가] [전체 허용]  │
└─────────────────────────────────┘
```

#### 10.2.3 위치 권한 거부

```mermaid
flowchart TD
    A[분석 시작] --> B{위치 권한 상태}

    B -->|granted| C[Geocoding 수행]
    B -->|denied| D[좌표만 사용하여 분석]

    D --> E[분석 완료]
    E --> F[결과 화면 + 위치 제한 안내]

    F --> G[위치 권한 허용 유도 배너]
    G --> H{사용자 선택}
    H -->|허용하기| I[설정으로 이동]
    H -->|무시| J[현재 상태 유지]
```

**위치 권한 없음 안내:**
```
┌─────────────────────────────────┐
│ ℹ️ GPS 좌표만 표시됩니다         │
│ 위치 권한을 허용하면 주소와      │
│ 장소명을 자동으로 표시합니다.    │
│ [    위치 권한 허용    ]        │
└─────────────────────────────────┘
```

### 10.3 데이터 관련 예외 처리

#### 10.3.1 GPS 없는 사진 처리

```mermaid
flowchart TD
    A[사진 선택 완료] --> B[메타데이터 검사]

    B --> C{GPS 포함 사진 수}

    C -->|전체 포함| D[정상 분석 진행]
    C -->|일부 포함| E[부분 GPS 안내]
    C -->|전체 없음| F[GPS 없음 안내]

    E --> G[GPS 없는 사진 표시]
    G --> H{사용자 선택}
    H -->|그대로 진행| I[GPS 있는 사진만 지도 표시]
    H -->|GPS 없는 사진 제외| J[해당 사진 제거 후 진행]
    H -->|취소| K[사진 선택으로 복귀]

    F --> L{사용자 선택}
    L -->|시간순 정렬만| M[지도 없이 타임라인만 생성]
    L -->|다른 사진 선택| K
    L -->|취소| K
```

**GPS 없음 안내 다이얼로그:**
```
┌─────────────────────────────────┐
│                                 │
│   📍 위치 정보가 없어요         │
│                                 │
│   선택한 50장 중 32장에         │
│   GPS 정보가 없습니다.          │
│                                 │
│   ┌─────────────────────────┐  │
│   │ GPS 없음: 32장           │  │
│   │ ┌───┬───┬───┬───┐       │  │
│   │ │📷│📷│📷│...│       │  │
│   │ └───┴───┴───┴───┘       │  │
│   └─────────────────────────┘  │
│                                 │
│   [  GPS 있는 사진만 분석  ]    │
│   [   시간순 정렬만 진행   ]    │
│   [        취소          ]     │
│                                 │
└─────────────────────────────────┘
```

#### 10.3.2 시간 정보 없는 사진

```mermaid
flowchart TD
    A[메타데이터 추출] --> B{촬영 시간 확인}

    B -->|시간 있음| C[정상 처리]
    B -->|시간 없음| D[파일 생성 시간 사용]

    D --> E[대체 시간 사용 알림]
    E --> F[⚠️ 마크와 함께 표시]
```

#### 10.3.3 저장 공간 부족

```mermaid
flowchart TD
    A[저장 시도] --> B{저장 공간 확인}

    B -->|충분| C[저장 진행]
    B -->|부족| D[저장 실패]

    D --> E[공간 부족 안내]
    E --> F{사용자 선택}
    F -->|설정으로 이동| G[iOS 저장공간 설정]
    F -->|이전 기록 삭제| H[기록 관리 화면]
    F -->|취소| I[저장 취소]
```

**저장 공간 부족 안내:**
```
┌─────────────────────────────────┐
│                                 │
│   💾 저장 공간이 부족해요        │
│                                 │
│   기록을 저장하려면 약 50MB의   │
│   여유 공간이 필요합니다.       │
│                                 │
│   현재 사용 가능: 12MB          │
│                                 │
│   [   저장공간 관리   ]         │
│   [ 이전 기록 삭제하기 ]        │
│   [       취소       ]         │
│                                 │
└─────────────────────────────────┘
```

### 10.4 네트워크 관련 예외 처리

#### 10.4.1 Geocoding 실패

```mermaid
flowchart TD
    A[Geocoding 요청] --> B{응답 확인}

    B -->|성공| C[주소 정보 저장]
    B -->|실패 - 네트워크| D[재시도 로직]
    B -->|실패 - 서버 오류| E[좌표만 표시]
    B -->|실패 - 알 수 없는 위치| F[좌표만 표시]

    D --> G{재시도 횟수}
    G -->|3회 미만| A
    G -->|3회 이상| E

    E --> H[⚠️ 주소 변환 실패 표시]
    F --> H
```

#### 10.4.2 AI API 오류

```mermaid
flowchart TD
    A[AI 스토리 생성 요청] --> B{API 응답}

    B -->|성공| C[스토리 표시]
    B -->|401 Unauthorized| D[API Key 오류 안내]
    B -->|429 Rate Limit| E[요청 한도 안내]
    B -->|500 Server Error| F[서버 오류 안내]
    B -->|Timeout| G[타임아웃 안내]
    B -->|Network Error| H[네트워크 오류 안내]

    D --> I[API Key 재설정 유도]
    E --> J[잠시 후 재시도 안내]
    F --> J
    G --> K[재시도 버튼]
    H --> K

    K --> L{재시도?}
    L -->|Yes| A
    L -->|No| M[무료 기능으로 계속]
```

**AI API 오류 다이얼로그:**
```
┌─────────────────────────────────┐
│                                 │
│   🤖 AI 스토리 생성 실패        │
│                                 │
│   API 요청 한도에 도달했습니다.  │
│   잠시 후 다시 시도해주세요.     │
│                                 │
│   남은 크레딧: 45               │
│                                 │
│   [    나중에 다시 시도   ]     │
│   [ 무료 기능으로 계속하기 ]    │
│                                 │
└─────────────────────────────────┘
```

### 10.5 사용자 입력 오류

#### 10.5.1 잘못된 API Key 형식

```mermaid
flowchart TD
    A[API Key 입력] --> B{형식 검증}

    B -->|OpenAI: sk-로 시작| C[형식 정상]
    B -->|Anthropic: sk-ant-로 시작| C
    B -->|형식 오류| D[즉시 오류 표시]

    D --> E[올바른 형식 안내]
    E --> A

    C --> F[연결 테스트]
```

**형식 오류 인라인 표시:**
```
┌─────────────────────────────────┐
│ ┌─────────────────────────────┐ │
│ │ invalid-key-format          │ │
│ └─────────────────────────────┘ │
│ ⚠️ OpenAI API Key는 'sk-'로    │
│    시작해야 합니다              │
└─────────────────────────────────┘
```

#### 10.5.2 중복 기록 감지

```mermaid
flowchart TD
    A[저장 시도] --> B{중복 확인}

    B -->|새 기록| C[정상 저장]
    B -->|유사 기록 존재| D[중복 안내]

    D --> E{사용자 선택}
    E -->|새로 저장| C
    E -->|기존 기록 업데이트| F[기존 기록에 병합]
    E -->|취소| G[저장 취소]
```

**중복 기록 안내:**
```
┌─────────────────────────────────┐
│                                 │
│   📋 비슷한 기록이 있어요       │
│                                 │
│   "제주도 3박4일" (1/15 ~ 1/18) │
│   과 겹치는 사진이 35장 있습니다 │
│                                 │
│   [   새로운 기록으로 저장  ]   │
│   [ 기존 기록에 사진 추가하기]   │
│   [         취소          ]    │
│                                 │
└─────────────────────────────────┘
```

### 10.6 에러 화면 템플릿 (SCR-019)

**일반 에러:**
```
┌─────────────────────────────────┐
│                                 │
│                                 │
│         [에러 아이콘]           │
│            ⚠️                   │
│                                 │
│   문제가 발생했어요              │
│                                 │
│   {에러 상세 메시지}            │
│                                 │
│                                 │
│   [      다시 시도      ]       │
│   [       홈으로       ]        │
│                                 │
│   문제가 계속되면               │
│   [문의하기]를 통해 알려주세요   │
│                                 │
└─────────────────────────────────┘
```

**복구 불가능한 에러:**
```
┌─────────────────────────────────┐
│                                 │
│                                 │
│         [심각 에러 아이콘]       │
│            ❌                   │
│                                 │
│   앱에 문제가 발생했어요         │
│                                 │
│   죄송합니다. 예기치 않은       │
│   오류가 발생했습니다.          │
│                                 │
│   [  오류 보고서 전송  ]        │
│   [    앱 재시작     ]         │
│                                 │
└─────────────────────────────────┘
```

---

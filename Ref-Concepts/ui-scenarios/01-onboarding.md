← [인덱스](index.md)

---

## 2. 앱 진입 및 온보딩

### 2.1 앱 실행 플로우

> **v3.1 변경사항**: 장소 등록 선택적 단계 추가 (Context Classification 지원)

```mermaid
flowchart TD
    A[앱 실행] --> B[스플래시 화면 표시]
    B --> C{앱 상태 확인}

    C --> D{첫 실행 여부}
    D -->|첫 실행| E[온보딩 시작]
    D -->|재실행| F{권한 상태 확인}

    F -->|권한 정상| G[홈 화면]
    F -->|권한 변경됨| H[권한 재요청 안내]
    H --> I{사용자 선택}
    I -->|설정으로 이동| J[iOS 설정 앱 열기]
    I -->|나중에| G

    E --> K[온보딩 화면 1: 서비스 소개]
    K --> L[온보딩 화면 2: 사진 권한]
    L --> M{권한 요청 결과}
    M -->|허용| N[온보딩 화면 3: 위치 권한]
    M -->|거부| O[제한된 기능 안내]
    O --> N

    N --> P{위치 권한 결과}
    P -->|허용| PLACE[온보딩 화면 4: 장소 등록 안내]
    P -->|거부| R[위치 없이 계속 안내]
    R --> PLACE

    PLACE --> PLACE_Q{사용자 선택}
    PLACE_Q -->|장소 등록하기| PLACE_REG[장소 등록 화면]
    PLACE_Q -->|나중에| Q[온보딩 완료]

    PLACE_REG --> Q

    Q --> G
```

### 2.2 온보딩 화면 상세

#### SCR-002: 온보딩 1 - 서비스 소개

**화면 구성:**
```
┌─────────────────────────────────┐
│                                 │
│      [일러스트레이션]            │
│      사진 → 지도 → 스토리        │
│                                 │
├─────────────────────────────────┤
│                                 │
│   사진 몇 장이면 충분해요         │
│                                 │
│   여행인지, 일상인지,            │
│   AI가 자동으로 파악하고         │
│   스토리로 만들어 드려요         │
│                                 │
├─────────────────────────────────┤
│                                 │
│   ● ○ ○                        │
│                                 │
│   [      다 음      ]           │
│                                 │
└─────────────────────────────────┘
```

**동작:**
- 좌우 스와이프로 페이지 이동 가능
- "다음" 버튼 탭 시 다음 온보딩 화면으로 이동
- 페이지 인디케이터로 현재 위치 표시

#### SCR-003: 온보딩 2 - 사진 권한 요청

**화면 구성:**
```
┌─────────────────────────────────┐
│                                 │
│      [사진 아이콘]              │
│                                 │
├─────────────────────────────────┤
│                                 │
│   사진에 접근할 수 있도록        │
│   허용해 주세요                 │
│                                 │
│   ┌─────────────────────────┐   │
│   │ • 사진의 촬영 시간과 위치   │   │
│   │   정보를 분석합니다        │   │
│   │ • 사진은 기기 내에서만     │   │
│   │   처리되며 서버로 전송     │   │
│   │   되지 않습니다           │   │
│   └─────────────────────────┘   │
│                                 │
├─────────────────────────────────┤
│                                 │
│   ○ ● ○                        │
│                                 │
│   [    사진 접근 허용    ]      │
│                                 │
└─────────────────────────────────┘
```

**권한 요청 시나리오:**

```mermaid
flowchart TD
    A[사진 접근 허용 버튼 탭] --> B[iOS 권한 다이얼로그 표시]

    B --> C{사용자 선택}

    C -->|모든 사진 허용| D[전체 접근 권한 획득]
    D --> E[✅ 다음 단계로 이동]

    C -->|선택한 사진만 허용| F[제한된 접근 권한]
    F --> G[제한 모드 안내 표시]
    G --> H{사용자 선택}
    H -->|계속하기| E
    H -->|설정에서 변경| I[iOS 설정으로 이동]

    C -->|허용 안 함| J[접근 거부 처리]
    J --> K[필수 기능 안내]
    K --> L{사용자 선택}
    L -->|설정에서 허용| I
    L -->|종료| M[앱 종료 또는 제한 모드]
```

**제한 모드 안내 (사진 접근 거부 시):**
```
┌─────────────────────────────────┐
│                                 │
│     ⚠️ 사진 접근 필요           │
│                                 │
│   Wander는 사진의 메타데이터를   │
│   분석하여 동선을 파악합니다.    │
│                                 │
│   사진 접근 없이는 서비스를      │
│   이용할 수 없어요.             │
│                                 │
│   [  설정에서 허용하기  ]       │
│   [      나중에       ]        │
│                                 │
└─────────────────────────────────┘
```

#### SCR-004: 온보딩 3 - 위치 권한 요청

**화면 구성:**
```
┌─────────────────────────────────┐
│                                 │
│      [위치 아이콘]              │
│                                 │
├─────────────────────────────────┤
│                                 │
│   위치 정보 사용을 허용하면      │
│   더 정확한 분석이 가능해요      │
│                                 │
│   ┌─────────────────────────┐   │
│   │ • GPS 좌표를 주소로 변환   │   │
│   │ • 장소 이름 자동 인식     │   │
│   │ • 위치 정보는 기기에서만   │   │
│   │   처리됩니다             │   │
│   └─────────────────────────┘   │
│                                 │
│   💡 허용하지 않아도 기본 기능   │
│      사용이 가능합니다          │
│                                 │
├─────────────────────────────────┤
│                                 │
│   ○ ○ ●                        │
│                                 │
│   [    위치 사용 허용    ]      │
│   [   허용하지 않고 계속  ]     │
│                                 │
└─────────────────────────────────┘
```

**위치 권한 플로우:**

```mermaid
flowchart TD
    A{사용자 선택}

    A -->|위치 사용 허용| B[iOS 위치 권한 다이얼로그]
    A -->|허용하지 않고 계속| C[위치 없이 진행]

    B --> D{권한 선택}
    D -->|앱 사용 중에만 허용| E[위치 권한 획득]
    D -->|한 번만 허용| F[일회성 권한]
    D -->|허용 안 함| C

    E --> G[온보딩 완료 화면]
    F --> G
    C --> G

    G --> H[홈 화면으로 이동]
```

#### SCR-004-1: 온보딩 4 - 장소 등록 안내 (선택 사항)

> **v3.1 신규**: Context Classification 정확도 향상을 위한 선택적 장소 등록

**화면 구성:**
```
┌─────────────────────────────────┐
│                                 │
│      [집/회사 아이콘]           │
│                                 │
├─────────────────────────────────┤
│                                 │
│   일상과 여행을 더 정확하게      │
│   구분할 수 있어요              │
│                                 │
│   ┌─────────────────────────┐   │
│   │ 🏠 집, 🏢 회사/학교        │   │
│   │ 위치를 등록하면           │   │
│   │ AI가 일상/여행을 90% 이상 │   │
│   │ 정확하게 구분해요          │   │
│   │                           │   │
│   │ 💡 등록하지 않아도        │   │
│   │ 패턴을 학습해 점차 정확해져요 │   │
│   └─────────────────────────┘   │
│                                 │
├─────────────────────────────────┤
│                                 │
│   ○ ○ ○ ●                      │
│                                 │
│   [    장소 등록하기    ]       │
│   [   나중에 설정하기   ]       │
│                                 │
└─────────────────────────────────┘
```

**장소 등록 화면 (SCR-004-2):**
```
┌─────────────────────────────────┐
│  ◀        장소 등록       완료  │
├─────────────────────────────────┤
│                                 │
│  🏠 집                          │
│  ┌─────────────────────────────┐│
│  │ 🔍 주소 검색...              ││
│  └─────────────────────────────┘│
│  또는 [📍 현재 위치로 등록]      │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  🏢 회사                         │
│  ┌─────────────────────────────┐│
│  │ 🔍 주소 검색...              ││
│  └─────────────────────────────┘│
│  또는 [📍 현재 위치로 등록]      │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  🏫 학교                         │
│  ┌─────────────────────────────┐│
│  │ 🔍 주소 검색...              ││
│  └─────────────────────────────┘│
│  또는 [📍 현재 위치로 등록]      │
│                                 │
│  ─────────────────────────────  │
│                                 │
│  💡 최소 1곳 이상 등록하면       │
│     일상/여행 구분이 정확해져요  │
│                                 │
│  [모두 건너뛰기 →]               │
│                                 │
└─────────────────────────────────┘
```

**장소 등록 동작:**

| 항목 | 동작 |
|------|------|
| 주소 검색 | MapKit MKLocalSearch로 검색 |
| 현재 위치 등록 | CLLocationManager로 현재 좌표 획득 |
| 최소 등록 | 없음 (모두 건너뛰기 가능) |
| 저장 위치 | SwiftData UserPlace 모델 |
| **H3 인덱스 계산** | 좌표 저장 시 SwiftyH3로 H3 셀 인덱스 자동 계산 (내부, 사용자 비노출) |

**미등록 시 자동 학습 안내:**
```
┌─────────────────────────────────┐
│                                 │
│  ✓ 나중에 설정할게요            │
│                                 │
│  괜찮아요! Wander가 여러분의     │
│  일상 패턴을 자동으로 학습해요.  │
│                                 │
│  ┌─────────────────────────────┐│
│  │ 📊 자주 가는 곳을 발견하면   ││
│  │ 알려드릴게요                ││
│  └─────────────────────────────┘│
│                                 │
│  [      시작하기      ]         │
│                                 │
└─────────────────────────────────┘
```

---

### 2.3 온보딩 완료 후 저장 데이터

```swift
// UserDefaults 저장 항목
struct OnboardingState {
    var isOnboardingCompleted: Bool     // 온보딩 완료 여부
    var photoPermissionStatus: String   // "full" | "limited" | "denied"
    var locationPermissionStatus: String // "always" | "whenInUse" | "denied"
    var placesRegistered: Bool          // v3.1: 장소 등록 여부
    var onboardingCompletedDate: Date   // 완료 일시
}
```
